{% extends "layouts/main.html" %}

{% block pageTitle %}
  Manage and Customize Error Messages – {{ serviceName }} – GOV.UK Prototype Kit
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <p>govuk-grid-column-full</p>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-xl">Create and manage error messages</h1>

        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Question"
              },
              value: {
                text: "When did the cattle arrive?",
                html: '<span id="question-value">When did the cattle arrive?</span>'
              }
            },
            {
              key: {
                text: "Conditions applied"
              },
              value: {
                html: "<li>Must be today or in the past</li><li>Max 34 days in the past</li>"
              }
            }
          ]
        }) }}
      </div>     </div>

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

          <!-- Input Field for News Title -->
          <div class="component-guide-preview-page">
            <div class="component-guide-preview component-guide-preview--simple">
              <div class="gem-c-contextual-guidance" data-module="contextual-guidance">
                <div class="gem-c-contextual-guidance__input-field">
                  <div class="govuk-form-group">
                    <label for="news-title" class="govuk-label govuk-label--m">Description label for error messages</label>
                    <input aria-describedby="news-title-guidance" class="gem-c-input govuk-input" id="news-title" name="news-title" spellcheck="false" type="text">


 <!-- Autogenerated Label -->
 <p id="autogenerated-label" class="govuk-body" style="display: none;">
  Autogenerated label: <span id="autogenerated-label-text"></span>
</p>

                  </div>
                </div>
              </div>
            </div>
          </div>


      <!-- Generate Preview Button -->
      <button type="button" id="generate-preview-button" class="govuk-button govuk-button--secondary" data-module="govuk-button">
        Generate preview
      </button>


          <!-- Error Message Cards -->
          <div id="error-message-cards">
            <!-- Error 1: Nothing is entered -->
            <div class="card collapsed" id="card-1">
              <h2 class="govuk-heading-m">Nothing is entered</h2>
              <p class="preview-text" id="preview-text-1"><span class="highlight">[Description]</span> must be entered.</p>
              <button type="button" class="govuk-button govuk-button--secondary edit-button" data-module="govuk-button" style="display: none;" onclick="toggleCard('card-1')">

                Edit
              </button>
              <div class="edit-area">
                <label class="govuk-label" for="edit-text-1">Edit message:</label>
                <textarea class="govuk-textarea" id="edit-text-1" rows="1"></textarea>
              </div>
            </div>

            <!-- Error 2: Incomplete date -->
            <div class="card collapsed" id="card-2">
              <h2 class="govuk-heading-m">Incomplete date</h2>
              <p class="preview-text" id="preview-text-2"><span class="highlight">[Description]</span> must include a day, month, or year.</p>
              <button type="button" class="govuk-button govuk-button--secondary edit-button" data-module="govuk-button" style="display: none;" onclick="toggleCard('card-2')">

                Edit
              </button>
              <div class="edit-area">
                <label class="govuk-label" for="edit-text-2">Edit message:</label>
                <textarea class="govuk-textarea" id="edit-text-2" rows="1"></textarea>
              </div>
            </div>

            <!-- Error 3: Incorrect Date -->
            <div class="card collapsed" id="card-3">
              <h2 class="govuk-heading-m">Incorrect Date</h2>
              <p class="preview-text" id="preview-text-3"><span class="highlight">[Description]</span> must be a real date.</p>
              <button type="button" class="govuk-button govuk-button--secondary edit-button" data-module="govuk-button" style="display: none;" onclick="toggleCard('card-3')">

                Edit
              </button>
              <div class="edit-area">
                <label class="govuk-label" for="edit-text-3">Edit message:</label>
                <textarea class="govuk-textarea" id="edit-text-3" rows="1"></textarea>
              </div>
            </div>
          </div>

          <!-- Save and Continue Button -->
          <form action="/confirmation" method="post" novalidate>
            {{ govukButton({
              text: "Save and continue"
            }) }}
          </form>
        </div>

        <div class="govuk-grid-column-one-quarter">
          <div class="gem-c-contextual-guidance__wrapper" id="news-title-guidance" style="display: none;">
            <div class="gem-c-contextual-guidance__guidance">
              <h2 class="govuk-heading-s">Writing a short description</h2>
              <p>The description should directly include language from the question.</p>

              <p class="govuk-body">For example:</p>
              <ul class="govuk-list">
                <li><strong>Question:</strong> ‘How many hours do you work a week?</li>
                <li><strong>Label:</strong> 'hours you work a week’</li>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>












<script>window.GOVUK = window.GOVUK || {};
  window.GOVUK.Modules = window.GOVUK.Modules || {};

  (function (Modules) {
    function ContextualGuidance($module) {
      this.$module = $module;
      this.$guidance = document.getElementById('news-title-guidance');  // Changed selector to match ID
      this.$input = this.$module.querySelector('#news-title');
    }

    ContextualGuidance.prototype.init = function () {
      if (!this.$input) return;
      this.$input.addEventListener('focus', this.handleFocus.bind(this));
      this.$input.addEventListener('blur', this.handleBlur.bind(this));
    };

    ContextualGuidance.prototype.handleFocus = function () {
      this.$guidance.style.display = 'block';  // Show guidance when input is focused
    };

    ContextualGuidance.prototype.handleBlur = function () {
      this.$guidance.style.display = 'none';   // Hide guidance when input loses focus
    };

    Modules.ContextualGuidance = ContextualGuidance;
  })(window.GOVUK.Modules);

  document.addEventListener('DOMContentLoaded', function () {
    var modules = document.querySelectorAll('[data-module="contextual-guidance"]');
    modules.forEach(function (module) {
      new window.GOVUK.Modules.ContextualGuidance(module).init();
    });
  });

</script>

<script>
  // Function to auto-generate description label based on question content
  function autoGenerateDescription() {
      const questionElement = document.getElementById('question-value');
      if (!questionElement) {
        console.error("Question element not found!");
        return;
      }

      const questionText = questionElement.textContent.trim().toLowerCase();
      let generatedLabel = generateSubject(questionText);

      // Update the autogenerated label
      const autoLabel = document.getElementById('autogenerated-label');
      const autoLabelText = document.getElementById('autogenerated-label-text');

      // Set the text of the autogenerated label
      autoLabelText.textContent = generatedLabel;

      // Show the autogenerated label container
      autoLabel.style.display = 'block';

      console.log('Generated Description:', generatedLabel); // Log for debugging
  }

  // Function to map question to a subject-based phrase
  function generateSubject(question) {
      let lowerCaseQuestion = question.toLowerCase();

      // Define a set of mappings for typical interrogative words to subject-based phrases
      const mappings = [
          { match: "when", replacement: "Date" },
          { match: "where", replacement: "Location" },
          { match: "who", replacement: "Person" },
          { match: "what", replacement: "Details" }
      ];

      // Start by removing the question mark
      let cleanQuestion = lowerCaseQuestion.replace("?", "");

      // Remove auxiliary verbs like "did", "does", "is", etc.
      const auxiliaryVerbs = ["did", "does", "is", "are", "was", "were", "will", "can"];
      cleanQuestion = cleanQuestion.split(' ').filter(word => !auxiliaryVerbs.includes(word)).join(' ');

      // Loop through the mappings and replace the interrogative word with its subject counterpart
      mappings.forEach(mapping => {
          if (cleanQuestion.startsWith(mapping.match)) {
              cleanQuestion = cleanQuestion.replace(mapping.match, mapping.replacement);
          }
      });

      // Capitalize the first letter of the result
      return cleanQuestion.charAt(0).toUpperCase() + cleanQuestion.slice(1);
  }

  // Automatically generate description when the DOM is fully loaded
  document.addEventListener('DOMContentLoaded', function() {
      autoGenerateDescription();  // Trigger the description generation when the page is loaded
  });

  // Optional: Monitor changes in the #question-value element using MutationObserver
  const observer = new MutationObserver(() => {
    autoGenerateDescription();  // Regenerate the label whenever content changes
  });

  const targetNode = document.getElementById('question-value');
  if (targetNode) {
    observer.observe(targetNode, { characterData: true, subtree: true, childList: true });
  }



  </script>

<script>

  let toolbarVisible = false;
  let isLabelGenerated = false;  // Flag to prevent the label from being regenerated

  // Add event listener for the "Generate Preview" button
  document.getElementById('generate-preview-button').addEventListener('click', updateErrorMessages);

  // Add event listener for the "Auto-generate Description" button (if needed)
  document.getElementById('auto-generate-button').addEventListener('click', autoGenerateDescription);

  // Function to auto-generate description label based on question content
  function autoGenerateDescription() {
      if (isLabelGenerated) {
          return;  // Prevent re-generation of the label
      }

      const questionElement = document.getElementById('question-value');
      if (!questionElement) {
        console.error("Question element not found!");
        return;
      }

      const questionText = questionElement.textContent.trim().toLowerCase();
      let generatedLabel = generateSubject(questionText);

      // Update the autogenerated label
      const autoLabel = document.getElementById('autogenerated-label');
      const autoLabelText = document.getElementById('autogenerated-label-text');

      // Set the text of the autogenerated label
      autoLabelText.textContent = generatedLabel;

      // Show the autogenerated label container
      autoLabel.style.display = 'block';

      // Set the flag to prevent re-generation
      isLabelGenerated = true;

      console.log('Generated Description:', generatedLabel); // Log for debugging
  }

  // Function to map question to a subject-based phrase
  function generateSubject(question) {
      let lowerCaseQuestion = question.toLowerCase();

      // Define a set of mappings for typical interrogative words to subject-based phrases
      const mappings = [
          { match: "when", replacement: "Date" },
          { match: "where", replacement: "Location" },
          { match: "who", replacement: "Person" },
          { match: "what", replacement: "Details" }
      ];

      // Start by removing the question mark
      let cleanQuestion = lowerCaseQuestion.replace("?", "");

      // Remove auxiliary verbs like "did", "does", "is", etc.
      const auxiliaryVerbs = ["did", "does", "is", "are", "was", "were", "will", "can"];
      cleanQuestion = cleanQuestion.split(' ').filter(word => !auxiliaryVerbs.includes(word)).join(' ');

      // Loop through the mappings and replace the interrogative word with its subject counterpart
      mappings.forEach(mapping => {
          if (cleanQuestion.startsWith(mapping.match)) {
              cleanQuestion = cleanQuestion.replace(mapping.match, mapping.replacement);
          }
      });

      // Capitalize the first letter of the result
      return cleanQuestion.charAt(0).toUpperCase() + cleanQuestion.slice(1);
  }

  // Automatically generate description when the DOM is fully loaded
  document.addEventListener('DOMContentLoaded', function() {
      autoGenerateDescription();  // Trigger the description generation when the page is loaded
  });

  // Function to update error message previews based on 'news-title' input
  function updateErrorMessages() {
    const descriptionLabel = document.getElementById('news-title').value.trim() || '[Description]';
    const highlightedLabel = `<span class="highlight">${descriptionLabel.charAt(0).toUpperCase() + descriptionLabel.slice(1).toLowerCase()}</span>`;

    // Update the preview text with highlighting
    document.getElementById('preview-text-1').innerHTML = `${highlightedLabel} must be entered.`;
    document.getElementById('preview-text-2').innerHTML = `${highlightedLabel} must include a day, month, or year.`;
    document.getElementById('preview-text-3').innerHTML = `${highlightedLabel} must be a real date.`;

    // Ensure the autogenerated label is not regenerated
    if (!isLabelGenerated) {
      autoGenerateDescription();  // Only generate if not yet generated
    }

    // Show the edit buttons
    const editButtons = document.querySelectorAll('.edit-button');
    editButtons.forEach(button => {
      button.style.display = 'inline-block'; // Show the edit buttons after preview generation
    });
  }

  function toggleCard(cardId) {
    const card = document.getElementById(cardId);
    const button = card.querySelector('button');
    const editArea = card.querySelector('.edit-area');
    const textArea = editArea.querySelector('textarea');
    const previewText = card.querySelector('.preview-text');

    // Check the current state of the card and button text
    if (card.classList.contains('collapsed')) {
        // If the card is collapsed, expand it and switch to "Save changes"
        card.classList.remove('collapsed');
        card.classList.add('expanded');
        button.textContent = 'Save changes';  // Change button to "Save changes"
        editArea.style.display = 'block';  // Show the edit area

        // Pre-fill the textarea with the current preview text
        textArea.value = previewText.textContent.trim();
        textArea.focus();  // Focus the textarea after expanding the card

    } else {
        // If the card is expanded, save changes and collapse it
        const updatedText = textArea.value.trim();  // Get the updated text from textarea

        // Handle empty textarea: ensure there's always some content to display
        const descriptionLabel = document.getElementById('news-title').value.trim() || '[Description]';
        const highlightedLabel = `<span class="highlight">${descriptionLabel.charAt(0).toUpperCase() + descriptionLabel.slice(1).toLowerCase()}</span>`;

        // Update the preview text with the new value and preserve the highlight
        previewText.innerHTML = updatedText.replace(descriptionLabel, highlightedLabel);

        // Collapse the card and switch to "Edit"
        card.classList.remove('expanded');
        card.classList.add('collapsed');
        button.textContent = 'Edit';  // Revert button to "Edit"
        editArea.style.display = 'none';  // Hide the edit area
    }
  }

  function applyGlobalSave() {
    alert('All changes saved!');
  }

  function resetAll() {
    document.querySelectorAll('textarea').forEach(el => el.value = '');
    document.querySelectorAll('.preview-text').forEach(el => el.innerHTML = '<span class="highlight">[Description]</span> must be entered.');
    document.querySelectorAll('[id^="live-preview-"]').forEach(el => el.innerHTML = '<span class="highlight">[Description]</span> must be entered.');
  }

</script>


<style>
  /* General Styling */
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .highlight {
        background-color: #ffe5cc;
        border-bottom: 2px solid #ffb266;
  }

  /* Card Styling */
  .card {
    border: 1px solid #b1b4b6;
    padding: 30px;
    margin-bottom: 20px;
    background-color: white;
  }

  .card.collapsed {
    max-height: 120px;
    overflow: hidden;
  }

  .card.expanded {
    max-height: 600px;
  }

  /* Edit Area */
  .edit-area {
    margin-top: 15px;
    display: none;
  }

  .expanded .edit-area {
    display: block;
  }

  /* Floating Toolbar */
  .floating-toolbar {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    background-color: #fff;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    padding: 15px;
    z-index: 100;
    transition: opacity 0.3s ease;
    opacity: 1;
    pointer-events: all;
  }

  .floating-toolbar.hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Live Preview Pane */
  .preview-pane {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 300px;
    padding: 15px;
    border: 1px solid #b1b4b6;
    background-color: #f9f9f9;
    z-index: 50;
    transition: transform 0.5s ease;
    transform: translateX(0);
  }

  .preview-pane.hidden {
    transform: translateX(110%);
  }

  .preview-pane h2 {
    margin-top: 0;
  }

  .gem-c-contextual-guidance__guidance {
    padding-top: 25px;
        padding-left: 0;
        border-top: 5px solid #fd0;
        border-left: 0;

}

#guidance-details {
  margin-top: 10px;
}

.govuk-details__text {
  display: none;
}

.govuk-details__text[aria-expanded="true"] {
  display: block;
}

</style>

{% endblock %}
