{% extends "layouts/main.html" %}

{% block pageTitle %}
  Manage and Customize Error Messages – {{ serviceName }} – GOV.UK Prototype Kit
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-l">Create and manage error messages</h1>

        {{ govukSummaryList({
          rows: [
            {
              key: {
                text: "Question"
              },
              value: {
                text: "When did the cattle arrive?",
                html: '<span id="question-value">When did the cattle arrive in their new holding?</span>'
              }
            },
            {
              key: {
                text: "Conditions applied"
              },
              value: {
                html: "<li>Must be today or in the past</li><li>Max 34 days in the past</li>"
              }
            }
          ]
        }) }}
      </div>     </div>

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

          <!-- Input Field for News Title -->
          <div class="component-guide-preview-page">
            <div class="component-guide-preview component-guide-preview--simple">
              <div class="gem-c-contextual-guidance" data-module="contextual-guidance">
                <div class="gem-c-contextual-guidance__input-field">
                  <div class="govuk-form-group">
                    <label for="news-title" class="govuk-label govuk-label--m">Description label for error messages</label>
                    <input aria-describedby="news-title-guidance" class="gem-c-input govuk-input" id="news-title" name="news-title" spellcheck="false" type="text">





                    <!-- Autogenerated Label -->
                    <p id="autogenerated-label" class="govuk-body govuk-!-margin-top-2" style="display: none;">
                      Autogenerated label: <span id="autogenerated-label-text"></span>
                    </p>

                  </div>
                </div>
              </div>
            </div>
          </div>

      <!-- Generate Preview Button -->
      <button type="button" id="generate-preview-button" class="govuk-button govuk-button--secondary" data-module="govuk-button">
        Generate previews
      </button>

<!-- Error 1: Name is required -->
<div class="card" id="card-1">
  <h2 class="govuk-heading-m">Name is required</h2>
  <p class="preview-text" id="summary-name"><span class="highlight">[Description]</span> must be entered</p>

  <details class="govuk-details">
      <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">Edit</span><span class="govuk-visually-hidden"> description for when users don't enter anything</span>
      </summary>
      <div class="govuk-details__text">
          <div class="edit-area">
              <label class="govuk-label" for="edit-text-1">Edit message:</label>
              <textarea class="govuk-textarea" id="edit-text-1" rows="1"></textarea>
              <button type="button" class="govuk-button save-changes-button">Save changes</button>

          </div>
      </div>
  </details>
</div>

<!-- Error 2: Date of birth is incomplete -->
<div class="card" id="card-2">
  <h2 class="govuk-heading-m">Date of birth is incomplete</h2>
  <p class="preview-text" id="summary-dob"><span class="highlight">[Description]</span> must include a day, month, or year</p>

  <details class="govuk-details">
      <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">Edit</span><span class="govuk-visually-hidden"> description for when users leave a date field empty</span>
      </summary>
      <div class="govuk-details__text">
          <div class="edit-area">
              <label class="govuk-label" for="edit-text-2">Edit message:</label>
              <textarea class="govuk-textarea" id="edit-text-2" rows="1"></textarea>
              <button type="button" class="govuk-button save-changes-button">Save changes</button>

          </div>
      </div>
  </details>
</div>

<!-- Error 3: Must be today or in the past -->
<div class="card" id="card-4">
  <h2 class="govuk-heading-m">Must be today or in the past</h2>
  <p class="preview-text" id="summary-incorrect"><span class="highlight">[Description]</span> must be today or in the past</p>

  <details class="govuk-details">
      <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">Edit</span><span class="govuk-visually-hidden"> description for when users enter a date in the future</span>
      </summary>
      <div class="govuk-details__text">
          <div class="edit-area">
              <label class="govuk-label" for="edit-text-4">Edit message:</label>
              <textarea class="govuk-textarea" id="edit-text-4" rows="1"></textarea>
              <button type="button" class="govuk-button save-changes-button">Save changes</button>

          </div>
      </div>
  </details>
</div>

<!-- Error 4: Max 34 days in the past -->
<div class="card" id="card-5">
  <h2 class="govuk-heading-m">Max 34 days in the past</h2>
  <p class="preview-text" id="summary-max-34"><span class="highlight">[Description]</span> must be the same as or after 2 September 2024</p>

  <details class="govuk-details">
      <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">Edit</span><span class="govuk-visually-hidden"> description for when users enter a date more than 34 days in the past</span>
      </summary>
      <div class="govuk-details__text">
          <div class="edit-area">
              <label class="govuk-label" for="edit-text-5">Edit message:</label>
              <textarea class="govuk-textarea" id="edit-text-5" rows="1"></textarea>
              <button type="button" class="govuk-button save-changes-button">Save changes</button>

          </div>
      </div>
  </details>
</div>
<button type="submit" class="govuk-button" data-module="govuk-button">
  Save and continue
</button>
</div>



<div class="govuk-grid-column-one-quarter">
  <div class="gem-c-contextual-guidance__wrapper" id="news-title-guidance" >
    <div class="gem-c-contextual-guidance__guidance">
      <h2 class="govuk-heading-s">Writing a short description</h2>
      <p>The description should directly include language from the question.</p>

      <p class="govuk-body">For example:</p>
      <ul class="govuk-list">
        <li><strong>Question:</strong> ‘How many hours do you work a week?</li>
        <li><strong>Label:</strong> 'hours you work a week’</li>
      </ul>
    </div>
  </div>
</div>

  <!-- Consolidated Script to Handle Error Message Cards and Generate Previews -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Flag to prevent the label from being regenerated multiple times
        let isLabelGenerated = false;

        // Function to handle updating the description label
        function autoGenerateDescription() {
            const questionElement = document.getElementById('question-value');
            if (!questionElement) {
                console.error("Question element not found!");
                return;
            }

            const questionText = questionElement.textContent.trim().toLowerCase();
            let generatedLabel = generateSubject(questionText);

            // Update the autogenerated label
            const autoLabel = document.getElementById('autogenerated-label');
            const autoLabelText = document.getElementById('autogenerated-label-text');

            // Set the text of the autogenerated label
            if (autoLabelText) {
                autoLabelText.textContent = generatedLabel;
            }

            // Show the autogenerated label container
            if (autoLabel) {
                autoLabel.style.display = 'block';
            }

            console.log('Generated Description:', generatedLabel); // Log for debugging
        }

        // Function to map question to a subject-based phrase
        function generateSubject(question) {
            let lowerCaseQuestion = question.toLowerCase();

            // Define a set of mappings for typical interrogative words to subject-based phrases
            const mappings = [
                { match: "when", replacement: "Date" },
                { match: "where", replacement: "Location" },
                { match: "who", replacement: "Person" },
                { match: "what", replacement: "Details" }
            ];

            // Start by removing the question mark
            let cleanQuestion = lowerCaseQuestion.replace("?", "");

            // Remove auxiliary verbs like "did", "does", "is", etc.
            const auxiliaryVerbs = ["did", "does", "is", "are", "was", "were", "will", "can"];
            cleanQuestion = cleanQuestion.split(' ').filter(word => !auxiliaryVerbs.includes(word)).join(' ');

            // Loop through the mappings and replace the interrogative word with its subject counterpart
            mappings.forEach(mapping => {
                if (cleanQuestion.startsWith(mapping.match)) {
                    cleanQuestion = cleanQuestion.replace(mapping.match, mapping.replacement);
                }
            });

            // Capitalize the first letter of the result
            return cleanQuestion.charAt(0).toUpperCase() + cleanQuestion.slice(1);
        }

        // Function to handle details toggle (open/close) for each card
        function handleDetailsToggle(detailsElement, textarea, previewTextElement) {
            detailsElement.addEventListener('toggle', function() {
                if (detailsElement.open) { // Details is opened
                    // Prefill the textarea with the current preview text (stripping HTML)
                    const previewTextHTML = previewTextElement.innerHTML.trim();

                    // Create a temporary element to strip HTML tags
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = previewTextHTML;
                    const plainPreviewText = tempElement.textContent || tempElement.innerText || "";

                    textarea.value = plainPreviewText;
                } else { // Details is closed
                    // No action needed on details close since updates are handled by the "Save changes" button
                }
            });
        }

        // Function to initialize all cards
        function initializeCards() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const detailsElement = card.querySelector('details');
                const textarea = card.querySelector('.edit-area textarea');
                const previewTextElement = card.querySelector('.preview-text');
                const saveButton = card.querySelector('.save-changes-button');

                if (detailsElement && textarea && previewTextElement && saveButton) {
                    // Initialize toggle behavior
                    handleDetailsToggle(detailsElement, textarea, previewTextElement);

                    // Attach event listener to the "Save changes" button
                    saveButton.addEventListener('click', function() {
                        const updatedText = textarea.value.trim();

                        // Retrieve the description label
                        const descriptionInput = document.getElementById('news-title');
                        const descriptionLabel = descriptionInput ? (descriptionInput.value.trim() || '[Description]') : '[Description]';
                        const highlightedLabel = `<span class="highlight">${descriptionLabel.charAt(0).toUpperCase()}${descriptionLabel.slice(1).toLowerCase()}</span>`;

                        // Replace the [Description] placeholder with the highlighted label
                        const regex = new RegExp('\\[Description\\]', 'gi');
                        const newPreviewText = updatedText.replace(regex, highlightedLabel);

                        // Update the preview text
                        previewTextElement.innerHTML = newPreviewText || `${highlightedLabel} must be entered.`;

                        // Close the details element after saving
                        detailsElement.removeAttribute('open');
                    });
                }
            });
        }

        // Function to update all error messages based on the description label
        function updateErrorMessages() {
            const descriptionInput = document.getElementById('news-title');
            const descriptionLabel = descriptionInput ? (descriptionInput.value.trim() || '[Description]') : '[Description]';
            const highlightedLabel = `<span class="highlight">${descriptionLabel.charAt(0).toUpperCase()}${descriptionLabel.slice(1).toLowerCase()}</span>`;

            // Select all preview-text elements
            const previewTexts = document.querySelectorAll('.preview-text');
            previewTexts.forEach(previewText => {
                // Use the data-default-message attribute if available
                const defaultMessage = previewText.getAttribute('data-default-message') || `[Description] must be entered.`;
                const newMessage = defaultMessage.replace(/\[Description\]/gi, highlightedLabel);
                previewText.innerHTML = newMessage;
            });

            // Show the edit buttons after generating previews
            const editButtons = document.querySelectorAll('.edit-button');
            editButtons.forEach(button => {
                button.style.display = 'inline-block'; // Show the edit buttons after preview generation
            });

            // Prevent label regeneration if it's already done
            if (!isLabelGenerated) {
                autoGenerateDescription();  // Only generate if not yet generated
                isLabelGenerated = true;
            }

            console.log('Highlighted Label:', highlightedLabel);
        }

        // Initialize all cards on page load
        initializeCards();

        // Add event listener for the "Generate Preview" button
        const generatePreviewButton = document.getElementById('generate-preview-button');
        if (generatePreviewButton) {
            generatePreviewButton.addEventListener('click', updateErrorMessages);
        } else {
            console.error('Generate Preview button not found!');
        }

        // Add event listener for the "Auto-generate Description" button (if needed)
        const autoGenerateButton = document.getElementById('auto-generate-button');
        if (autoGenerateButton) {
            autoGenerateButton.addEventListener('click', autoGenerateDescription);
        } else {
            // It's optional; log a message if not present
            console.log('Auto-generate Description button not found or not needed.');
        }

        // Optional: Monitor changes in the #question-value element using MutationObserver
        const observer = new MutationObserver(() => {
            autoGenerateDescription();  // Regenerate the label whenever content changes
        });

        const targetNode = document.getElementById('question-value');
        if (targetNode) {
            observer.observe(targetNode, { characterData: true, subtree: true, childList: true });
        }
    });
  </script>

  <!-- Contextual Guidance Module Script -->
  <script>
    window.GOVUK = window.GOVUK || {};
    window.GOVUK.Modules = window.GOVUK.Modules || {};

    (function (Modules) {
        function ContextualGuidance($module) {
            this.$module = $module;
            this.$guidance = document.getElementById('news-title-guidance');
            this.$input = this.$module.querySelector('#news-title');
        }

        ContextualGuidance.prototype.init = function () {
            if (!this.$input) return;
            this.$input.addEventListener('focus', this.handleFocus.bind(this));
            this.$input.addEventListener('blur', this.handleBlur.bind(this));  // You can comment this out if not needed
        };

        ContextualGuidance.prototype.handleFocus = function () {
            this.$guidance.style.display = 'block';  // Show guidance when input is focused
        };

        ContextualGuidance.prototype.handleBlur = function () {
            // Commenting this out ensures the guidance isn't hidden
            // this.$guidance.style.display = 'none';  // Remove this to keep the guidance visible
        };

        Modules.ContextualGuidance = ContextualGuidance;
    })(window.GOVUK.Modules);
  </script>

  <!-- Auto-Generate Description Script -->
  <script>
    // Function to auto-generate description label based on question content
    function autoGenerateDescription() {
        const questionElement = document.getElementById('question-value');
        if (!questionElement) {
            console.error("Question element not found!");
            return;
        }

        const questionText = questionElement.textContent.trim().toLowerCase();
        let generatedLabel = generateSubject(questionText);

        // Update the autogenerated label
        const autoLabel = document.getElementById('autogenerated-label');
        const autoLabelText = document.getElementById('autogenerated-label-text');

        // Set the text of the autogenerated label
        if (autoLabelText) {
            autoLabelText.textContent = generatedLabel;
        }

        // Show the autogenerated label container
        if (autoLabel) {
            autoLabel.style.display = 'block';
        }

        console.log('Generated Description:', generatedLabel); // Log for debugging
    }

    // Function to map question to a subject-based phrase
    function generateSubject(question) {
        let lowerCaseQuestion = question.toLowerCase();

        // Define a set of mappings for typical interrogative words to subject-based phrases
        const mappings = [
            { match: "when", replacement: "Date" },
            { match: "where", replacement: "Location" },
            { match: "who", replacement: "Person" },
            { match: "what", replacement: "Details" }
        ];

        // Start by removing the question mark
        let cleanQuestion = lowerCaseQuestion.replace("?", "");

        // Remove auxiliary verbs like "did", "does", "is", etc.
        const auxiliaryVerbs = ["did", "does", "is", "are", "was", "were", "will", "can"];
        cleanQuestion = cleanQuestion.split(' ').filter(word => !auxiliaryVerbs.includes(word)).join(' ');

        // Loop through the mappings and replace the interrogative word with its subject counterpart
        mappings.forEach(mapping => {
            if (cleanQuestion.startsWith(mapping.match)) {
                cleanQuestion = cleanQuestion.replace(mapping.match, mapping.replacement);
            }
        });

        // Capitalize the first letter of the result
        return cleanQuestion.charAt(0).toUpperCase() + cleanQuestion.slice(1);
    }

    // Automatically generate description when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        autoGenerateDescription();  // Trigger the description generation when the page is loaded
    });

    // Optional: Monitor changes in the #question-value element using MutationObserver
    const observer = new MutationObserver(() => {
        autoGenerateDescription();  // Regenerate the label whenever content changes
    });

    const targetNode = document.getElementById('question-value');
    if (targetNode) {
        observer.observe(targetNode, { characterData: true, subtree: true, childList: true });
    }
  </script>






<style>
  /* General Styling */
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .highlight {
        background-color: #ffe5cc;
        border-bottom: 2px solid #ffb266;
  }

  /* Card Styling */
  .card {
    border: 1px solid #b1b4b6;
    padding: 30px;
    margin-bottom: 20px;
    background-color: white;
  }

  .card.collapsed {
    max-height: 120px;
    overflow: hidden;
  }

  .card.expanded {
    max-height: 600px;
  }

  /* Edit Area */
  .edit-area {
    margin-top: 15px;
  }

  .expanded .edit-area {
    display: block;
  }


  /* Live Preview Pane */
  .preview-pane {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 300px;
    padding: 15px;
    border: 1px solid #b1b4b6;
    background-color: #f9f9f9;
    z-index: 50;
    transition: transform 0.5s ease;
    transform: translateX(0);
  }

  .preview-pane.hidden {
    transform: translateX(110%);
  }

  .preview-pane h2 {
    margin-top: 0;
  }

  .gem-c-contextual-guidance__guidance {
    padding-top: 25px;
        padding-left: 0;
        border-top: 5px solid #fd0;
        border-left: 0;

}

#guidance-details {
  margin-top: 10px;
}


</style>

{% endblock %}
